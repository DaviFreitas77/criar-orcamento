<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Criar Orçamento</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .header {
            margin-bottom: 20px;
            padding: 10px 15px;
            border: 1px solid #007BFF;
            border-radius: 5px;
            background-color: #E3F2FD;
            color: #0D47A1;
        }

        .header h2 {
            margin: 0 0 5px 0;
            font-weight: bold;
        }

        .header p {
            margin: 2px 0;
            font-size: 14px;
        }

        .buttons {
            margin-bottom: 20px;
        }

        .buttons button {
            margin-right: 10px;
            padding: 10px 15px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        table {
            width: 60%;
            border-collapse: collapse;
            min-width: 400px;
            border: 1px solid #000;
        }

        th,
        td {
            border: 1px solid #000;
            padding: 4px;
            text-align: left;
        }

        /* Estilo para a tabela do total */
        #table-total {
            margin-top: 20px;
        }
    </style>
</head>

<body>

    <div class="buttons">
        <button id="btn-add-colunm">Adicionar coluna</button>
        <button id="btn-add-row">Adicionar Linha</button>
        <button id="export-pdf">Exportar para PDF</button>
    </div>

    <h1>Criar orçamento</h1>

    <table id="table">
        <div class="header">
            <h2>Paulino Empreiteira</h2>
            <p>Email: paulino.empreiteira@gmail.com</p>
            <p>Contato: (11) 99999-9999</p>
        </div>
        <thead>
            <tr>
                <th id="tittle-colunm">Material</th>
                <th id="tittle-colunm">Quantidade</th>
                <th style="background-color: yellow;" id="tittle-colunm">SubTotal</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <!-- Tabela de total -->
    <h2>Total do Orçamento</h2>
    <table id="table-total" style="width: 60%; border-collapse: collapse; min-width: 400px; border: 1px solid #000;">
        <thead>
            <tr>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td id="total-value">R$ 0,00</td>
            </tr>
        </tbody>
    </table>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        const addColunmButton = document.querySelector('#btn-add-colunm');
        const addRowButton = document.querySelector('#btn-add-row');
        const exportPdfButton = document.querySelector('#export-pdf');
        const table = document.querySelector('#table');
        const tableHead = document.querySelector('#table thead');
        const tr = tableHead.querySelector('tr');
        const tableBody = document.querySelector('#table tbody');

        addColunmButton.addEventListener('click', () => {
            const ths = tr.querySelectorAll('th');
            ths.forEach((th, index) => {
                if (th.textContent.toLowerCase() === 'subtotal') {

                    const newth = document.createElement('th')
                    const texTH = prompt('Digite o nome da nova coluna:');

                    if (texTH === '') {
                        alert('Digite um nome para a nova coluna');
                        return;
                    }

                    newth.textContent = texTH
                    th.parentNode.insertBefore(newth, th)

                    const rows = tableBody.querySelectorAll('tr');
                    if (rows.length === 0) {
                        alert('Não há linhas na tabela para adicionar a nova coluna.');
                        return;
                    }
                    rows.forEach(row => {
                        const newTd = document.createElement('td');
                        const text = prompt(`digite o valor da nova coluna ${texTH}`);
                        newTd.textContent = text;
                        row.insertBefore(newTd, row.children[index]); // insere no mesmo índice do <th>
                    });

                }
            }
            )
        })

        addRowButton.addEventListener('click', () => {
            const newRow = document.createElement('tr');
            const ths = tr.querySelectorAll('th');

            ths.forEach(th => {
                const newTd = document.createElement('td');
                let text = prompt(`Digite o valor para ${th.textContent}`);

                if (th.textContent.toLowerCase() === 'subtotal') {
                    // tenta converter para número
                    let valorNum = parseFloat(text.replace(',', '.')); // aceita vírgula como decimal
                    if (isNaN(valorNum)) {
                        newTd.textContent = '-';
                    } else {
                        // formata para moeda BRL
                        newTd.textContent = valorNum.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    }
                } else {
                    newTd.textContent = text;
                }

                newRow.appendChild(newTd);
            });

            tableBody.appendChild(newRow);
            atualizarTotal(); // atualiza o total ao adicionar linha
        });

        function atualizarTotal() {
            let total = 0;
            const rows = tableBody.querySelectorAll('tr');
            const ths = tr.querySelectorAll('th');
            let subtotalIndex = -1;
            ths.forEach((th, i) => {
                if (th.textContent.toLowerCase() === 'subtotal') {
                    subtotalIndex = i;
                }
            });
            if (subtotalIndex === -1) return;

            rows.forEach(row => {
                const tds = row.querySelectorAll('td');
                if (tds.length > subtotalIndex) {
                    let valorStr = tds[subtotalIndex].textContent;
                    valorStr = valorStr.replace(/[R$\s\.]/g, '').replace(',', '.');
                    const valorNum = parseFloat(valorStr);
                    if (!isNaN(valorNum)) {
                        total += valorNum;
                    }
                }
            });

            const totalValueTd = document.querySelector('#total-value');
            totalValueTd.textContent = total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        exportPdfButton.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Adiciona o cabeçalho com os dados da empresa no topo do PDF
            doc.setFontSize(16);
            doc.setTextColor(13, 71, 161);
            doc.text("Paulino Empreiteira", 14, 15);

            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text("Email: paulino.empreiteira@gmail.com", 14, 22);
            doc.text("Contato: (11) 99999-9999", 14, 28);

            // Espaço antes da tabela
            doc.autoTable({
                html: '#table',
                startY: 35,
                theme: 'grid',
                styles: {
                    fontSize: 10,
                    lineWidth: 0.2,
                    lineColor: [0, 0, 0],
                    textColor: [0, 0, 0],
                },
                headStyles: {
                    fillColor: [255, 255, 255],
                },
                didParseCell: function (data) {
                    if (
                        data.section === 'head' &&
                        data.cell.raw &&
                        data.cell.raw.textContent.toLowerCase() === 'subtotal'
                    ) {
                        data.cell.styles.fillColor = [255, 255, 0]; // Amarelo
                        data.cell.styles.textColor = [0, 0, 0]; // Texto preto
                    }
                }
            });

            // Adiciona o total logo após a tabela
            const finalY = doc.lastAutoTable.finalY || 35;

            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text('Total do Orçamento:', 14, finalY + 10);

            // Pega o valor total exibido na página
            const totalValue = document.querySelector('#total-value').textContent;
            doc.setFontSize(14);
            doc.setTextColor(13, 71, 161);
            doc.text(totalValue, 60, finalY + 10);

            doc.save('orcamento.pdf');
        });

    </script>

</body>

</html>